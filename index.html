<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Partidas</title>
    
    <style>
        /* --- Configura√ß√£o Base e Fundo Escuro --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #12121e; /* Fundo escuro principal */
            color: #e0e0e0;
            line-height: 1.6;
            overflow-x: hidden; /* Evita que os "blobs" causem scroll horizontal */
            min-height: 100vh;
            padding: 20px;
        }

        /* --- Efeito de "Blobs" de Fundo para o Glassmorphism --- */
        body::before,
        body::after {
            content: '';
            position: fixed;
            z-index: -1;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.2;
        }

        /* Blob 1 */
        body::before {
            background: #9f55ff; /* Roxo */
            width: 350px;
            height: 350px;
            top: -100px;
            left: -100px;
        }

        /* Blob 2 */
        body::after {
            background: #008cff; /* Azul */
            width: 400px;
            height: 400px;
            bottom: -150px;
            right: -150px;
        }

        /* --- Estilo "Liquid Glass" (Glassmorphism) --- */
        .glass-effect {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
        }

        /* --- Container Principal --- */
        .app-container {
            max-width: 900px;
            margin: 40px auto;
            padding: 25px;
        }

        /* --- Abas de Navega√ß√£o (HEADER) --- */
        .tabs {
            display: flex; /* Garante que fiquem lado a lado */
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap; /* Permite que as abas quebrem em telas menores */
        }

        .tab-link {
            flex-grow: 1; /* Faz com que dividam o espa√ßo igualmente */
            flex-basis: 0; /* Necess√°rio para o flex-grow funcionar bem */
            width: auto; 
            min-width: 140px; /* Evita que fiquem muito pequenos antes de quebrar */
            padding: 12px 15px;
            cursor: pointer;
            text-align: center;
            color: #ffffff;
            font-weight: 600;
            transition: all 0.3s ease;
            
            /* Remove estilos de bot√£o padr√£o se necess√°rio */
            border: none;
            background: none; /* Removido para usar o glass-effect */
        }
        
        .tab-link:not(.active) {
             background: rgba(255, 255, 255, 0.08); /* Fundo glass padr√£o */
        }

        .tab-link.active {
            background: rgba(255, 255, 255, 0.25); /* Mais destaque para a aba ativa */
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .tab-link:not(.active):hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* --- Conte√∫do das Abas --- */
        .tab-content-container {
            padding: 25px;
        }

        .tab-content {
            display: none; /* Esconde todas as abas por padr√£o */
        }

        .tab-content.active {
            display: block; /* Mostra apenas a aba ativa */
        }

        /* --- Estiliza√ß√£o de Formul√°rios (Inputs, Bot√µes) --- */
        textarea,
        input[type="number"],
        button,
        select { /* Adicionado select */
            width: 100%; /* Esta regra estava quebrando as abas */
            padding: 12px;
            margin-top: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
            color: #ffffff;
            font-size: 16px;
        }
        
        select option {
            background: #12121e;
        }

        textarea::placeholder {
            color: #aaa;
        }

        button {
            background: #007bff;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 20px;
        }
        
        /* --- Bot√µes de 'Copiar' em verde --- */
        #btn-gerar-lista-times,
        #btn-gerar-lista-partidas,
        #btn-copiar-resultados { 
             background: #28a745; /* Bot√£o verde para 'copiar' */
        }
        #btn-gerar-lista-times:hover,
        #btn-gerar-lista-partidas:hover,
        #btn-copiar-resultados:hover { 
             background: #218838;
        }
        
        /* --- Bot√£o de 'Limpar' em vermelho --- */
        #btn-limpar-resultados {
            background: #dc3545; /* Vermelho 'perigo' */
        }
        #btn-limpar-resultados:hover {
            background: #c82333;
        }

        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }

        /* --- NOVO: Estilo para os inputs divididos por g√™nero --- */
        .gender-split {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        .gender-column {
            flex: 1;
        }
        .gender-column h3 {
            margin-bottom: 5px;
            color: #e0e0e0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* --- Estiliza√ß√£o Espec√≠fica do Placar --- */
        .scoreboard {
            display: flex;
            justify-content: space-around;
            align-items: center;
            text-align: center;
            margin: 20px 0;
        }

        .score-display {
            font-size: 4rem;
            font-weight: bold;
            margin: 10px 0;
            color: #fff;
        }

        .score-vs {
            font-size: 2rem;
            color: #aaa;
        }

        .btn-score {
            font-size: 2rem;
            width: 60px; /* Este √© mais espec√≠fico, ent√£o sobrescreve o width: 100% */
            height: 60px;
            line-height: 60px;
            border-radius: 50%;
            padding: 0;
        }
        
        #placar-setup {
            margin-bottom: 20px;
        }

        /* --- Estiliza√ß√£o dos Times Gerados (COM CORES NEON) --- */
        #teams-output {
            display: grid;
            /* Esta linha j√° √© responsiva! */
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 15px;
            margin-bottom: 20px;
        }

        .team-card {
            padding: 15px;
            background: rgba(0, 0, 0, 0.15);
            border-radius: 8px;
            
            /* --- ESTILOS NEON (agora com cores suaves) --- */
            /* A cor √© injetada via JS na var --team-color */
            border: 2px solid var(--team-color, rgba(255, 255, 255, 0.1));
            box-shadow: 0 0 8px 0px var(--team-color, transparent), 
                        0 0 12px 1px var(--team-color, transparent) inset;
            transition: box-shadow 0.3s ease;
        }
        
        .team-card:hover {
             box-shadow: 0 0 15px 2px var(--team-color, transparent), 
                        0 0 12px 1px var(--team-color, transparent) inset;
        }

        .team-card h3 {
            /* A cor √© injetada via JS */
            color: var(--team-color, #00aaff); 
            border-bottom: 1px solid var(--team-color, #00aaff);
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

        .team-card ul {
            list-style: none;
            padding-left: 0;
            margin-top: 10px;
        }
        
        .team-card li {
            padding: 2px 0;
        }
        
        /* --- ESTILO PARA AS NOTAS DE REVEZAMENTO --- */
        .team-card-note {
            font-size: 0.85em;
            color: #ffab00; /* Laranja/Amarelo para destaque */
            background: rgba(255, 171, 0, 0.1);
            padding: 8px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .team-card-note-loan {
             /* Cor do H3 (vari√°vel) para a nota de emprestar */
             color: var(--team-color, #00aaff); 
             background: rgba(0, 170, 255, 0.1);
        }
        
        #rotation-output h3 {
            color: #ffab00;
            margin-top: 20px;
            border-bottom: 1px solid #ffab00;
            padding-bottom: 5px;
        }
        #rotation-output p {
            margin-bottom: 10px;
        }
        
        /* --- Textarea para Copiar Times --- */
        #teams-list-output,
        #partidas-list-output { 
            display: none; /* Come√ßa escondido */
            margin-top: 15px;
            height: 200px;
            background: rgba(0,0,0,0.3);
            color: #fff;
        }
        
        /* --- Aba de Partidas --- */
        #match-list-description {
            padding: 15px;
            background: rgba(0, 100, 200, 0.1);
            border: 1px solid rgba(0, 150, 255, 0.3);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        #match-list li {
            padding: 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
            margin-bottom: 5px;
        }
        
        /* Div para o bot√£o/textarea de copiar partidas */
        #partidas-list-copy {
            margin-top: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 20px;
        }


        /* Aplicando o efeito Glass nos elementos principais */
        .app-container,
        .tab-link,
        .tab-content-container {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
        }
        
        
        /* ------------------------------------------
        --- REGRAS DE RESPONSIVIDADE ---
        ------------------------------------------
        */
        
        /* Tablets e Telas Menores (abaixo de 768px) */
        @media (max-width: 768px) {
            body {
                padding: 10px; /* Reduz padding do corpo */
            }
            
            .app-container {
                margin: 10px auto;
                padding: 15px; /* Reduz padding do container */
            }

            .tab-content-container {
                padding: 15px;
            }
            
            /* Quebra os inputs de g√™nero em duas linhas no tablet/celular */
            .gender-split {
                flex-direction: column;
                gap: 10px;
            }
        }

        /* Celulares (abaixo de 480px) */
        @media (max-width: 480px) {
            body {
                padding: 0; /* Remove padding do body, deixa o app-container tomar conta */
                font-size: 14px; /* Reduz fonte base */
            }

            .app-container {
                margin: 0;
                padding: 10px;
                border-radius: 0; /* Tela cheia no celular */
                border: none;
                box-shadow: none; /* Remove sombra no celular */
            }
            
            .glass-effect {
                /* Desliga o efeito glass no celular, pode ser pesado e desnecess√°rio */
                background: rgba(255, 255, 255, 0.05);
                backdrop-filter: none;
                -webkit-backdrop-filter: none;
            }
            
            /* T√≠tulos */
            h2 {
                font-size: 1.3rem;
                margin-bottom: 15px;
            }
            h3 {
                font-size: 1.1rem;
            }

            /* Abas */
            .tabs {
                gap: 5px; /* Menos espa√ßo entre abas */
            }
            .tab-link {
                font-size: 0.85rem;
                padding: 10px 5px;
                min-width: 100px; /* Menor */
            }

            /* Placar */
            .scoreboard {
                flex-wrap: wrap; /* Permite quebrar se necess√°rio */
                gap: 10px;
            }
            .score-display {
                font-size: 2.5rem; /* Reduz drasticamente o placar */
            }
            .score-vs {
                font-size: 1.5rem;
            }
            .btn-score {
                width: 50px;
                height: 50px;
                line-height: 50px;
                font-size: 1.5rem;
            }
            
            /* Textareas de "Copiar" */
            #teams-list-output,
            #partidas-list-output {
                height: 150px;
            }
        }
        
    </style>
</head>
<body>

    <div class="app-container">
        <nav class="tabs">
            <button class="tab-link active" data-tab="tab-config">‚öôÔ∏è Configura√ß√£o</button>
            <button class="tab-link" data-tab="tab-times">üë• Times</button>
            <button class="tab-link" data-tab="tab-partidas">‚öîÔ∏è Partidas</button>
            <button class="tab-link" data-tab="tab-placar">üî¢ Placar</button>
            <button class="tab-link" data-tab="tab-resultados">üìã Resultados</button>
        </nav>

        <main class="tab-content-container">

            <section id="tab-config" class="tab-content active">
                <h2>‚öôÔ∏è Configura√ß√£o da Rodada</h2>
                <p>Insira os nomes dos jogadores nas listas correspondentes para balancear os times.</p>
                
                <div class="gender-split">
                    <div class="gender-column">
                        <h3 style="color: #90CAF9;">üöπ Masculino</h3>
                        <textarea id="men-input" rows="10" placeholder="Lista de homens..."></textarea>
                    </div>
                    <div class="gender-column">
                        <h3 style="color: #F48FB1;">üö∫ Feminino</h3>
                        <textarea id="women-input" rows="10" placeholder="Lista de mulheres..."></textarea>
                    </div>
                </div>
                
                <button id="btn-sortear">üé≤ Sortear Times Balanceados</button>
            </section>

            <section id="tab-times" class="tab-content">
                <h2>üë• Times Sorteados</h2>
                <div id="teams-output">
                    </div>
                
                <button id="btn-gerar-lista-times">Gerar Lista para Copiar</button>
                <textarea id="teams-list-output" readonly placeholder="A lista dos times para copiar aparecer√° aqui..."></textarea>
                
                <div id="rotation-output">
                    </div>
            </section>

            <section id="tab-partidas" class="tab-content">
                <h2>‚öîÔ∏è Controle de Partidas</h2>
                
                <div id="match-list-description">
                    <p>Abaixo est√° a lista de todos os jogos poss√≠veis ("todos contra todos").</p>
                    <p><strong>Como funciona a regra da pausa:</strong></O>
                    <p>Ao usar a aba "Placar", voc√™ (o operador) deve seguir a regra: um time que jogar <strong>2 partidas seguidas</strong> deve <strong>descansar na pr√≥xima</strong> rodada de jogos.</p>
                    <p>O sistema apenas lista as partidas. O controle de quem joga e quem pausa √© feito por voc√™ ao selecionar a partida na aba "Placar".</p>
                </div>
                
                <ul id="match-list">
                    </ul>
                
                <div id="partidas-list-copy">
                    <button id="btn-gerar-lista-partidas">üìã Gerar Lista de Partidas para Copiar</button>
                    <textarea id="partidas-list-output" readonly placeholder="A lista de partidas para copiar aparecer√° aqui..."></textarea>
                </div>
            </section>

            <section id="tab-placar" class="tab-content">
                <h2>üî¢ Placar da Partida</h2>
                
                <div id="placar-setup">
                    <label for="match-selector">Selecione a Partida:</label>
                    <select id="match-selector">
                        <option value="">-- Primeiro gere as partidas --</option>
                    </select>
                    <button id="btn-iniciar-partida">Iniciar Partida Selecionada</button>
                </div>
                
                <div class="scoreboard">
                    <div class="score-team">
                        <h3 id="placar-time-a">Time A</h3>
                        <div class="score-display" id="score-a">0</div>
                        <button class="btn-score" data-team="a" disabled>+</button>
                    </div>
                    <div class="score-vs">VS</div>
                    <div class="score-team">
                        <h3 id="placar-time-b">Time B</h3>
                        <div class="score-display" id="score-b">0</div>
                        <button class="btn-score" data-team="b" disabled>+</button>
                    </div>
                </div>
                <button id="btn-reset-placar">Resetar Placar</button>
                <button id="btn-finalizar-partida" disabled>Finalizar Partida (25pts)</button>
            </section>

            <section id="tab-resultados" class="tab-content">
                <h2>üìã Resultados Salvos</h2>
                <p>Resultados das partidas finalizadas, prontos para copiar:</p>
                <textarea id="results-output" rows="15" readonly></textarea>
                
                <button id="btn-copiar-resultados">üìã Copiar Resultados Salvos</button>
                <button id="btn-baixar-resumo">üíæ Baixar Resumo do Dia (PDF)</button>
                
                <button id="btn-limpar-resultados">‚ùå Limpar Hist√≥rico Salvo</button>
            </section>

        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- L√ìGICA DE NAVEGA√á√ÉO POR ABAS ---

            const tabLinks = document.querySelectorAll('.tab-link');
            const tabContents = document.querySelectorAll('.tab-content');

            tabLinks.forEach(link => {
                link.addEventListener('click', () => {
                    const tabId = link.getAttribute('data-tab');
                    // Remove 'active' de todos
                    tabLinks.forEach(item => item.classList.remove('active'));
                    tabContents.forEach(item => item.classList.remove('active'));
                    // Adiciona 'active' ao clicado
                    link.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });

            // --- FIM DA L√ìGICA DE ABAS ---


            // --- IN√çCIO DA L√ìGICA DO JOGO ---

            // Elementos da UI
            const btnSortear = document.getElementById('btn-sortear');
            // NOVOS INPUTS SEPARADOS
            const menInput = document.getElementById('men-input');
            const womenInput = document.getElementById('women-input');
            
            const teamsOutput = document.getElementById('teams-output');
            const rotationOutput = document.getElementById('rotation-output');
            
            const matchList = document.getElementById('match-list');
            const matchSelector = document.getElementById('match-selector');
            const btnIniciarPartida = document.getElementById('btn-iniciar-partida');
            
            const resultsOutput = document.getElementById('results-output');
            
            const btnGerarListaTimes = document.getElementById('btn-gerar-lista-times');
            const teamsListOutput = document.getElementById('teams-list-output');
            
            const btnGerarListaPartidas = document.getElementById('btn-gerar-lista-partidas');
            const partidasListOutput = document.getElementById('partidas-list-output');
            
            const btnCopiarResultados = document.getElementById('btn-copiar-resultados');
            const btnLimparResultados = document.getElementById('btn-limpar-resultados');
            const btnBaixarResumo = document.getElementById('btn-baixar-resumo');


            // --- Lista de Cores para Times (Tons mais suaves) ---
            const teamColors = [
                { name: "Laranja", hex: "#FF8A65" }, { name: "Verde", hex: "#66BB6A" },
                { name: "Azul", hex: "#42A5F5" },     { name: "Rosa", hex: "#F06292" },
                { name: "Ciano", hex: "#26C6DA" },    { name: "Amarelo", hex: "#FFEE58" },
                { name: "Violeta", hex: "#AB47BC" }
            ];

            // Vari√°veis globais
            let times = []; 
            let partidas = []; 
            let resultadosFinais = []; 

            // --- Persist√™ncia ---
            const STORAGE_KEY = 'gerenciadorPartidasResultados';
            function loadResultsFromLocalStorage() {
                const dadosSalvos = localStorage.getItem(STORAGE_KEY);
                if (dadosSalvos) {
                    resultadosFinais = JSON.parse(dadosSalvos);
                    resultsOutput.value = resultadosFinais.join('\n');
                }
            }
            function saveResultsToLocalStorage() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(resultadosFinais));
            }
            loadResultsFromLocalStorage();

            // --- 1. Sorteio de Jogadores (AGORA BALANCEADO) ---
            btnSortear.addEventListener('click', () => {
                // 1. L√™ as duas listas separadamente
                let men = menInput.value.split('\n').map(n => n.trim()).filter(n => n.length > 0);
                let women = womenInput.value.split('\n').map(n => n.trim()).filter(n => n.length > 0);
                
                const totalPlayers = men.length + women.length;
                const minJogadores = 13; 
                
                if (totalPlayers < minJogadores) {
                    alert(`S√£o necess√°rios pelo menos ${minJogadores} jogadores no total. Atual: ${totalPlayers}.`);
                    return;
                }
                
                // Embaralha as listas separadamente
                men = shuffleArray(men);
                women = shuffleArray(women);
                
                // Limpa sa√≠das anteriores
                teamsOutput.innerHTML = '';
                rotationOutput.innerHTML = '';
                teamsListOutput.style.display = 'none';
                partidasListOutput.style.display = 'none';
                times = [];
                let teamCounter = 1;

                // --- L√ìGICA DE SORTEIO BALANCEADO ---
                
                // Fun√ß√£o auxiliar para criar time
                function createTeamObj(playersList, type) {
                    const colorObj = teamColors[(teamCounter - 1) % teamColors.length];
                    return {
                        nome: `Time ${teamCounter++}`,
                        jogadores: shuffleArray(playersList), // Embaralha a ordem interna do time
                        tipo: type,
                        colorName: colorObj.name,
                        colorHex: colorObj.hex
                    };
                }

                // Calcula quantos times COMPLETOS (6 jogadores) podemos formar
                const numFullTeams = Math.floor(totalPlayers / 6);

                // Loop para criar os times completos tentando balancear
                for (let i = 0; i < numFullTeams; i++) {
                    let teamPlayers = [];
                    
                    // Calcula a propor√ß√£o ideal baseada nos jogadores RESTANTES
                    const menLeft = men.length;
                    const womenLeft = women.length;
                    const totalLeft = menLeft + womenLeft;
                    
                    // Quantos homens e mulheres esse time deve ter idealmente?
                    let numMenToTake = Math.round(6 * (menLeft / totalLeft));
                    let numWomenToTake = 6 - numMenToTake;

                    // Ajustes de seguran√ßa se faltar gente de um g√™nero
                    if (numMenToTake > menLeft) {
                        numMenToTake = menLeft;
                        numWomenToTake = 6 - numMenToTake;
                    } else if (numWomenToTake > womenLeft) {
                        numWomenToTake = womenLeft;
                        numMenToTake = 6 - numWomenToTake;
                    }

                    // Puxa os jogadores e adiciona a tag (M) ou (F)
                    for (let k = 0; k < numMenToTake; k++) teamPlayers.push(`${men.pop()} (M)`);
                    for (let k = 0; k < numWomenToTake; k++) teamPlayers.push(`${women.pop()} (F)`);

                    times.push(createTeamObj(teamPlayers, "completo"));
                }

                // Sobras formam o time de Revezamento ou Reserva
                let leftovers = [];
                while (men.length > 0) leftovers.push(`${men.pop()} (M)`);
                while (women.length > 0) leftovers.push(`${women.pop()} (F)`);

                if (leftovers.length > 0) {
                    const type = leftovers.length >= 3 ? "revezamento" : "reserva";
                    times.push(createTeamObj(leftovers, type));
                }
                
                exibirTimes();
                gerarPartidas(); 
                mudarDeAba('tab-times');
            });

            // *** FUN√á√ÉO ATUALIZADA (com Cores e Notas) ***
            function exibirTimes() {
                teamsOutput.innerHTML = '';
                rotationOutput.innerHTML = '';
                
                let hasRotation = false;
                let hasReserves = false;
                let reservePlayers = [];

                times.forEach(time => {
                    const card = document.createElement('div');
                    card.className = 'team-card';
                    card.style.setProperty('--team-color', time.colorHex);
                    
                    let tipoTimeLabel = "";
                    let cardNote = "";

                    switch(time.tipo) {
                        case 'completo':
                            tipoTimeLabel = "(Completo)";
                            cardNote = `<div class="team-card-note team-card-note-loan" style="background-color: ${time.colorHex}1A;"><b>Empresta jogadores</b> para times de revezamento quando estiver de pausa.</div>`;
                            break;
                        case 'revezamento':
                            tipoTimeLabel = "(Revezamento)";
                            const needs = 6 - time.jogadores.length;
                            cardNote = `<div class="team-card-note"><b>Recebe ${needs} jogador(es)</b> do time que est√° de pausa.</div>`;
                            hasRotation = true;
                            break;
                        case 'reserva':
                            tipoTimeLabel = "(Reserva)";
                            cardNote = `<div class="team-card-note"><b>N√£o joga.</b> Fica na espera.</div>`;
                            hasReserves = true;
                            reservePlayers.push(...time.jogadores);
                            break;
                    }
                    
                    let listaJogadoresHTML = time.jogadores.map(j => `<li>${j}</li>`).join('');
                    
                    card.innerHTML = `
                        <h3>${time.nome} (${time.colorName}) <span style="font-weight: 400; font-size: 0.9em;">${tipoTimeLabel}</span></h3>
                        <ul>${listaJogadoresHTML}</ul>
                        ${cardNote}
                    `;
                    teamsOutput.appendChild(card);
                });
                
                rotationOutput.innerHTML = `<h3>Regras de Revezamento e Reserva</h3>`;
                if (hasRotation) {
                    rotationOutput.innerHTML += `<p><b>REVEZAMENTO:</b> Os times de "Revezamento" (3-5 jogadores) ser√£o completados em seus jogos pelo time que estiver descansando.</p>`;
                }
                if (hasReserves) {
                     rotationOutput.innerHTML += `<p><b>RESERVA:</b> Os times "Reserva" (1-2 jogadores) n√£o participam das partidas. Os seguintes jogadores est√£o na reserva:</p><p><i>${reservePlayers.join(', ')}</i></p>`;
                }
            }
            
            // --- 2. Controle de Partidas ---
            function gerarPartidas() {
                partidas = [];
                matchList.innerHTML = '';
                matchSelector.innerHTML = '<option value="">-- Selecione uma partida --</option>';
                partidasListOutput.style.display = 'none';

                const timesAtivos = times.filter(time => time.tipo !== 'reserva');

                if (timesAtivos.length < 2) {
                    matchList.innerHTML = '<li>Times insuficientes para gerar partidas.</li>';
                    return;
                }

                for (let i = 0; i < timesAtivos.length; i++) {
                    for (let j = i + 1; j < timesAtivos.length; j++) {
                        const timeA = timesAtivos[i];
                        const timeB = timesAtivos[j];
                        partidas.push([timeA.nome, timeB.nome]); 
                        
                        const partidaTexto = `${timeA.nome} (${timeA.colorName}) vs ${timeB.nome} (${timeB.colorName})`;
                        const li = document.createElement('li');
                        li.textContent = partidaTexto;
                        matchList.appendChild(li);
                        
                        const option = document.createElement('option');
                        option.value = `${timeA.nome}|${timeB.nome}`;
                        option.textContent = partidaTexto;
                        matchSelector.appendChild(option);
                    }
                }
            }

            // --- 3. Contador de Pontos ---
            let placarA = 0;
            let placarB = 0;
            const scoreADisplay = document.getElementById('score-a');
            const scoreBDisplay = document.getElementById('score-b');
            const placarTimeA = document.getElementById('placar-time-a');
            const placarTimeB = document.getElementById('placar-time-b');
            const btnsScore = document.querySelectorAll('.btn-score');
            const btnFinalizar = document.getElementById('btn-finalizar-partida');
            
            btnIniciarPartida.addEventListener('click', () => {
                const selectedMatch = matchSelector.value;
                if (!selectedMatch) return alert('Por favor, selecione uma partida para iniciar.');
                
                const [timeAName, timeBName] = selectedMatch.split('|');
                const timeA = times.find(t => t.nome === timeAName);
                const timeB = times.find(t => t.nome === timeBName);
                
                placarTimeA.textContent = `${timeA.nome} (${timeA.colorName})`;
                placarTimeA.style.color = timeA.colorHex;
                placarTimeB.textContent = `${timeB.nome} (${timeB.colorName})`;
                placarTimeB.style.color = timeB.colorHex;
                
                resetarPlacar();
                btnsScore.forEach(btn => btn.disabled = false);
                // Mant√©m o bot√£o de finalizar desabilitado at√© ter pontua√ß√£o ou a partida acabar
                btnFinalizar.disabled = false; 
            });

            btnsScore.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const time = e.target.getAttribute('data-team');
                    if (time === 'a') scoreADisplay.textContent = ++placarA;
                    else scoreBDisplay.textContent = ++placarB;
                    
                    if (placarA >= 25 || placarB >= 25) {
                        alert('Partida finalizada! Clique em "Finalizar Partida" para salvar.');
                        btnsScore.forEach(b => b.disabled = true); // Bloqueia apenas os pontos
                    }
                });
            });

            document.getElementById('btn-reset-placar').addEventListener('click', resetarPlacar);
            
            btnFinalizar.addEventListener('click', () => {
                if (placarA === 0 && placarB === 0) return alert('O placar est√° 0 a 0.');
                
                const resultadoTexto = `Partida: ${placarTimeA.textContent} vs ${placarTimeB.textContent} | Placar: ${placarA} - ${placarB}`;
                resultadosFinais.push(resultadoTexto);
                resultsOutput.value = resultadosFinais.join('\n');
                saveResultsToLocalStorage();
                
                alert('Resultado salvo!');
                const optionToRemove = matchSelector.querySelector(`option[value="${matchSelector.value}"]`);
                if(optionToRemove) optionToRemove.remove();
                
                resetarPlacar();
                placarTimeA.textContent = "Time A"; placarTimeA.style.color = "#e0e0e0";
                placarTimeB.textContent = "Time B"; placarTimeB.style.color = "#e0e0e0";
                btnsScore.forEach(btn => btn.disabled = true);
                btnFinalizar.disabled = true;
                matchSelector.value = "";
            });

            function resetarPlacar() {
                placarA = 0; placarB = 0;
                scoreADisplay.textContent = 0; scoreBDisplay.textContent = 0;
                if(placarTimeA.textContent !== "Time A") btnsScore.forEach(btn => btn.disabled = false);
            }
            
            // --- Utilit√°rios de C√≥pia/Download/Limpar ---
            btnLimparResultados.addEventListener('click', () => {
                if (confirm('Tem certeza que deseja apagar permanentemente todo o hist√≥rico?')) {
                    resultadosFinais = [];
                    resultsOutput.value = '';
                    localStorage.removeItem(STORAGE_KEY);
                    alert('Hist√≥rico limpo.');
                }
            });

            async function copyTextToClipboard(text, elementToSelect) {
                if (navigator.clipboard && window.isSecureContext) {
                    try { await navigator.clipboard.writeText(text); alert('Copiado!'); return; } catch (err) {}
                }
                elementToSelect.style.display = 'block';
                elementToSelect.select();
                alert('Falha na c√≥pia autom√°tica. Copie manualmente da caixa de texto.');
            }

            btnGerarListaTimes.addEventListener('click', () => {
                if (!times.length) return alert('Primeiro sorteie os times.');
                let text = times.map(t => `--- ${t.nome} (${t.colorName}) ---\n${t.jogadores.join('\n')}`).join('\n\n');
                teamsListOutput.value = text;
                copyTextToClipboard(text, teamsListOutput);
            });

            btnGerarListaPartidas.addEventListener('click', () => {
                if (!partidas.length) return alert('Primeiro gere as partidas.');
                let text = "--- ORDEM DAS PARTIDAS ---\n\n" + partidas.map((p, i) => {
                    const tA = times.find(t => t.nome === p[0]);
                    const tB = times.find(t => t.nome === p[1]);
                    return `Jogo ${i+1}: ${tA.nome} (${tA.colorName}) vs ${tB.nome} (${tB.colorName})`;
                }).join('\n');
                partidasListOutput.value = text;
                copyTextToClipboard(text, partidasListOutput);
            });

            btnCopiarResultados.addEventListener('click', () => {
                if (!resultsOutput.value.trim()) return alert('N√£o h√° resultados para copiar.');
                copyTextToClipboard(resultsOutput.value, resultsOutput);
            });

            btnBaixarResumo.addEventListener('click', () => {
                if (typeof window.jspdf === 'undefined') return alert('Erro: Biblioteca PDF n√£o carregada.');
                if (!times.length && !resultadosFinais.length) return alert('N√£o h√° dados para baixar.');
                
                const doc = new window.jspdf.jsPDF();
                let y = 15; const margin = 10; const pageHeight = doc.internal.pageSize.height;
                const checkPageBreak = (h=10) => { if (y+h > pageHeight-margin) { doc.addPage(); y=15; } };

                doc.setFontSize(22); doc.text("Resumo do Jogo", margin, y); y+=10;
                doc.setFontSize(10); doc.setTextColor(100);
                doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, margin, y); y+=15;
                doc.setTextColor(0);

                doc.setFontSize(18); doc.text("Times Sorteados", margin, y); y+=8;
                times.forEach(t => {
                    checkPageBreak(20);
                    doc.setFontSize(14); doc.setTextColor(t.colorHex);
                    doc.text(`${t.nome} (${t.colorName}) [${t.tipo}]`, margin+5, y);
                    doc.setTextColor(0); doc.setFontSize(10); y+=6;
                    let lines = doc.splitTextToSize(t.jogadores.join(', '), 180);
                    doc.text(lines, margin+5, y);
                    y += (lines.length*5)+5;
                });

                checkPageBreak(20); y+=5;
                doc.setFontSize(18); doc.text("Resultados Salvos", margin, y); y+=8;
                doc.setFontSize(10);
                if(resultadosFinais.length) {
                     resultadosFinais.forEach(r => { checkPageBreak(8); doc.text(r, margin+5, y); y+=6; });
                } else { doc.text("Nenhum resultado salvo.", margin+5, y); }

                doc.save(`Resumo_Volei_${new Date().toISOString().slice(0,10)}.pdf`);
            });

            function shuffleArray(array) {
                let newArray = [...array];
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            }
            function mudarDeAba(tabId) {
                const target = document.querySelector(`.tab-link[data-tab="${tabId}"]`);
                if(target) target.click();
            }
        });
    </script>
</body>
</html>
